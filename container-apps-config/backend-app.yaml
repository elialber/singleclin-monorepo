# Azure Container App configuration for SingleClin Backend
# Usage: az containerapp create --yaml backend-app.yaml

properties:
  environmentId: /subscriptions/{subscription-id}/resourceGroups/singleclin-prod-rg/providers/Microsoft.App/managedEnvironments/singleclin-prod-env
  configuration:
    ingress:
      external: true
      targetPort: 8080
      transport: http
      traffic:
        - weight: 100
          latestRevision: true
      corsPolicy:
        allowedOrigins:
          - "https://singleclinprodacr.azurecr.io"
          - "https://*.azurecontainerapps.io"
        allowedMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        allowedHeaders:
          - "*"
        allowCredentials: true
    registries:
      - server: singleclinprodacr.azurecr.io
        identity: /subscriptions/{subscription-id}/resourceGroups/singleclin-prod-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/singleclin-prod-identity
    secrets: []
  template:
    containers:
      - image: singleclinprodacr.azurecr.io/singleclin-backend:latest
        name: singleclin-backend
        resources:
          cpu: 1.0
          memory: 2Gi
        env:
          - name: ASPNETCORE_ENVIRONMENT
            value: "Production"
          - name: ASPNETCORE_URLS
            value: "http://+:8080"
          - name: AzureKeyVault__VaultUrl
            value: "https://singleclin-kv-prod.vault.azure.net/"
          - name: AzureKeyVault__UseMangedIdentity
            value: "true"
          - name: Logging__LogLevel__Default
            value: "Information"
          - name: Logging__LogLevel__Microsoft
            value: "Warning"
          - name: Logging__LogLevel__Azure
            value: "Warning"
          - name: HealthChecks__Enabled
            value: "true"
        probes:
          - type: Liveness
            httpGet:
              path: /health/live
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          - type: Readiness
            httpGet:
              path: /health/ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 5
          - type: Startup
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
    scale:
      minReplicas: 0
      maxReplicas: 3
      rules:
        - name: http-scaling
          http:
            metadata:
              concurrentRequests: 10
        - name: cpu-scaling
          custom:
            type: cpu
            metadata:
              type: Utilization
              value: 70
        - name: memory-scaling
          custom:
            type: memory
            metadata:
              type: Utilization
              value: 80
    revisionSuffix: ""
  identity:
    type: UserAssigned
    userAssignedIdentities:
      /subscriptions/{subscription-id}/resourceGroups/singleclin-prod-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/singleclin-prod-identity: {}
location: East US
tags:
  Environment: Production
  Application: SingleClin
  Component: Backend
  CostCenter: SingleClin-Prod